<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MindLock — Bawal Edition (Fixed)</title>
<style>
  :root{--bg:#0f1720;--card:#0b1220;--accent:#7c3aed;--muted:#9aa4b2;--glass:rgba(255,255,255,0.04);--danger:#ef4444;--success:#22c55e;}
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  body{margin:0;background:linear-gradient(180deg,#071021 0%,#00121a 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:28px}
  .app{max-width:980px;width:100%}
  header{display:flex;flex-direction:column;gap:12px;margin-bottom:18px}
  @media(min-width:640px){header{flex-direction:row;align-items:center;justify-content:space-between}}
  h1{font-size:20px;margin:0;color:#fff}
  p.lead{margin:0;color:var(--muted);font-size:13px;max-width:450px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center}
  .icon{width:64px;height:64px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;color:#fff}
  .icon svg{width:32px;height:32px;color:white}
  .name{font-size:14px;font-weight:600}
  .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600;transition:transform 0.1s ease}
  .btn:active{transform:scale(0.95)}
  .primary{background:var(--accent);color:#fff}
  .muted{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
  footer{margin-top:28px;color:var(--muted);font-size:13px}
  .modal-backdrop{position:fixed;inset:0;background:rgba(1,6,10,0.6);display:none;align-items:center;justify-content:center;z-index:30;opacity:0;transition:opacity 0.2s ease}
  .modal-backdrop.show{display:flex;opacity:1}
  .modal{width:92%;max-width:420px;background:#071426;border-radius:12px;padding:18px;box-shadow:0 12px 40px rgba(2,6,23,0.7);transform:scale(0.95);transition:transform 0.2s ease}
  .modal-backdrop.show .modal{transform:scale(1)}
  .modal h2{margin:0 0 8px 0;font-size:18px;}
  .input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:var(--glass);color:#fff}
  .form-group{margin-bottom:10px}
  .form-group label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  .row{display:flex;gap:10px;align-items:center}
  .small{font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-start;}
  @media(min-width:640px){.controls{justify-content:flex-end}}
  .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted);cursor:pointer;border:1px solid transparent;transition:border-color .2s}
  .chip:hover{border-color:rgba(255,255,255,0.1)}
  .stats-grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px}
  .stat{background:rgba(255,255,255,0.03);padding:12px;border-radius:10px}
  .stat-bar{height:8px;background:rgba(255,255,255,0.05);border-radius:99px;margin-top:4px;overflow:hidden;}
  .stat-bar-inner{height:100%;background:var(--accent);border-radius:99px;transition:width 0.5s ease-out;}
  .settings{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  input[type=number]{width:80px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
  .linklike{background:transparent;border:0;color:var(--accent);cursor:pointer;padding:0;font-weight:600}
  .tiny{font-size:12px;color:var(--muted)}
  .danger{background:var(--danger);color:#fff}
  .ok{background:var(--success);color:#fff}
  #file-import{display:none}
  /* responsive */
  @media(min-width:720px){body{padding:40px}}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="MindLock prototype">
    <header>
      <div>
        <h1>MindLock — Bawal Edition</h1>
        <p class="lead">Click an app. A mindful pause will ask “Kya kaam se khol rahe ho?”. Answers stored locally.</p>
      </div>
      <div class="controls">
        <button id="btnStats" class="btn muted">Stats</button>
        <button id="btnSettings" class="btn muted">Settings</button>
        <button id="btnReset" class="btn danger">Reset</button>
      </div>
    </header>

    <section>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <div class="chip" id="addApp">＋ Add App</div>
        <div class="chip" id="toggleProtected">Toggle Protected Mode</div>
        <div class="tiny">Protected mode: <span id="modeText">ON</span></div>
      </div>

      <div class="grid" id="appsGrid" aria-live="polite">
        <!-- app cards filled by JS -->
      </div>

      <div class="settings" id="settingsPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center"><strong>Settings</strong><button id="closeSettings" class="linklike">Close</button></div>
        <div style="margin-top:8px">
          <label class="small">Cooldown (seconds)</label><br/>
          <input id="cooldown" type="number" min="0" value="4"> <span class="tiny">— prevent repeat prompts</span>
        </div>
        <div style="margin-top:8px">
          <label class="small">Whitelist (comma-separated package names)</label><br/>
          <input id="whitelist" type="text" class="input" placeholder="e.g., com.whatsapp,com.android.camera">
        </div>
        <div style="margin-top:14px; display:flex; gap:10px; flex-wrap: wrap; align-items: center;">
            <strong class="small">Data:</strong>
            <button id="btnExport" class="btn muted">Export Data</button>
            <button id="btnImport" class="btn muted">Import Data</button>
            <input type="file" id="file-import" accept=".json">
        </div>
        <div style="margin-top:14px;display:flex;gap:8px">
          <button id="saveSettings" class="btn primary">Save</button>
          <button id="cancelSettings" class="btn muted">Cancel</button>
        </div>
      </div>

      <div id="statsPanel" style="display:none;margin-top:12px">
        <strong>Stats</strong>
        <div class="stats-grid" id="statsWrap"></div>
      </div>

    </section>

    <footer>
      <div class="tiny">Ye prototype sirf personal practice ke liye hai. Local storage me data save hota hai. — Dil se, mindful coding.</div>
    </footer>
  </div>

  <!-- Reason Modal -->
  <div class="modal-backdrop" id="reasonBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle">Kya kaam se khol rahe ho?</h2>
      <div style="margin-bottom:10px" class="small">Type a short reason — ya quick pick karlo.</div>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap" id="quickChoices">
        <button class="chip">Work</button><button class="chip">Study</button><button class="chip">Quick check</button><button class="chip">Bored</button><button class="chip">Social</button>
      </div>
      <textarea id="reason" rows="3" class="input" placeholder="Yahan likho..."></textarea>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="cancelBtn" class="btn muted">Cancel</button>
        <button id="continueBtn" class="btn primary">Continue</button>
      </div>
      <div class="tiny" style="margin-top:8px;color:var(--muted)">Tip: Use the quick chips for speed. Responses are stored in your browser.</div>
    </div>
  </div>

  <!-- Add/Edit App Modal -->
  <div class="modal-backdrop" id="appModalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="appModalTitle">
        <h2 id="appModalTitle">Add New App</h2>
        <input type="hidden" id="appIdField">
        <div class="form-group">
            <label for="appLabel">App Label</label>
            <input type="text" id="appLabel" class="input" placeholder="e.g., YouTube">
        </div>
        <div class="form-group">
            <label for="appUrl">App URL</label>
            <input type="url" id="appUrl" class="input" placeholder="https://youtube.com">
        </div>
        <div class="form-group">
            <label for="appPkg">Package Name (unique ID)</label>
            <input type="text" id="appPkg" class="input" placeholder="com.google.android.youtube">
        </div>
        <div class="form-group row">
            <div>
                <label for="appColor">Icon Color</label>
                <input type="color" id="appColor" value="#7c3aed" style="width: 50px; height: 35px; padding: 4px; border-radius: 6px; border: 1px solid var(--glass); background: transparent;">
            </div>
            <div>
                <label for="appIcon">Icon SVG Code (optional)</label>
                <input type="text" id="appIcon" class="input" placeholder="<svg>...</svg>">
            </div>
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
            <button id="cancelAppModalBtn" class="btn muted">Cancel</button>
            <button id="saveAppModalBtn" class="btn primary">Save App</button>
        </div>
    </div>
  </div>


<script>
/* MindLock Web Prototype JS - Bawal Edition (FIXED)
   - Bug Fix: Apps now correctly open from the reason modal after clicking "Continue".
   - Feature: Added `title` attribute to delete button for better UX.
*/

const defaultApps = [
  {id:'youtube_1', label:'YouTube', color:'#ff0000', pkg:'com.google.android.youtube', url:'https://youtube.com', icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.267,4,12,4,12,4S5.733,4,4.186,4.418 c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.733,2,12,2,12s0,4.267,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.733,20,12,20,12,20s6.267,0,7.814-0.418c0.861-0.23,1.538-0.908,1.768-1.768C22,16.267,22,12,22,12S22,7.733,21.582,6.186z M10,15.464V8.536L16,12L10,15.464z"/></svg>'},
  {id:'instagram_1', label:'Instagram', color:'#E4405F', pkg:'com.instagram.android', url:'https://instagram.com', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line></svg>'},
  {id:'whatsapp_1', label:'WhatsApp', color:'#25D366', pkg:'com.whatsapp', url:'https://web.whatsapp.com', icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91S17.5 2 12.04 2zm4.41 11.75c-.22.12-.79.39-1.03.46-.23.07-.39.07-.56-.04-.16-.12-.41-.51-.78-1-2-.68-1.18-1.59-1.18-1.59s-.07-.08-.07-.08c-.07-.08-.18-.1-.28-.1-.1-.01-.22.03-.32.05-.1.02-.23.08-.34.12-.1.04-.18.06-.28.1s-.18.03-.28.01c-.1-.02-.22-.08-.3-.13-.09-.05-.18-.11-.25-.19-.07-.08-.15-.17-.22-.27-.07-.1-.13-.2-.18-.29-.05-.09-.1-.18-.14-.26-.04-.08-.08-.15-.1-.22-.03-.07-.05-.13-.06-.17-.01-.04-.03-.09-.04-.13-.01-.04-.02-.07-.02-.11s0-.09.01-.13c.01-.04.03-.09.05-.13.02-.04.05-.09.09-.13.04-.04.09-.09.14-.12.05-.03.1-.06.15-.08.05-.02.1-.04.16-.06.06-.02.1-.03.14-.04.04-.01.07-.02.1-.03s.09-.01.12-.01.09,0,.13.01c.04,0,.08.01.12.02l.13.03c.04.01.09.03.13.05.04.02.08.04.12.07.03.03.07.06.1.09.03.03.06.07.08.1.02.03.04.07.06.1.02.03.03.06.04.08.01.02.02.05.03.07.01.02.01.04.01.06s0,.05-.01.07c-.01.02-.02.04-.03.06-.01.02-.03.04-.04.06-.02.02-.03.04-.05.06-.02.02-.04.03-.06.05-.02.01-.05.03-.08.04-.03.01-.06.02-.09.03s-.07.01-.1.01h-.01c-.03,0-.07,0-.1-.01s-.07-.01-.1-.02c-.03-.01-.07-.02-.1-.04-.03-.02-.07-.03-.1-.05s-.07-.05-.1-.07c-.03-.02-.07-.05-.1-.08-.03-.03-.07-.06-.1-.09-.03-.03-.07-.07-.1-.1-.03-.03-.07-.07-.1-.1s-.07-.07-.1-.1c-.03-.03-.07-.07-.1-.11-.03-.04-.07-.08-.1-.13-.03-.05-.07-.09-.1-.14s-.06-.1-.09-.16c-.03-.06-.06-.11-.08-.17-.02-.06-.04-.12-.05-.18-.01-.06-.02-.13-.02-.19s.01-.12.02-.19c.02-.06.04-.12.07-.18.03-.06.06-.12.1-.18.04-.06.08-.12.13-.17.05-.05.1-.1.16-.15.06-.05.12-.09.18-.13.06-.04.13-.08.2-.11.07-.03.14-.06.22-.08s.16-.04.24-.05c.08-.01.17,0,.25.01.08.01.16.03.24.06.08.03.15.06.22.1.07.04.14.08.2.12.06.04.12.09.18.14.05.05.1.1.15.16.05.06.09.12.13.18.04.06.08.13.11.2.03.07.06.14.08.21.02.07.03.15.03.22s-.01.15-.03.22c-.02.07-.05.14-.08.21-.03.07-.07.13-.11.19-.04.06-.09.12-.13.17-.05.05-.1.1-.15.15l-.17.16c-.05.05-.1.09-.14.12-.04.03-.09.06-.13.08-.04.02-.08.04-.12.05-.04.01-.07.02-.1.03-.03.01-.06.01-.09.01h-.05c-.24,0-.48-.06-.69-.19-.22-.12-.42-.29-.59-.49-.17-.2-.32-.42-.44-.66-.12-.24-.18-.49-.18-.75,0-.31.08-.62.23-.89.15-.27.37-.5.64-.67.27-.17.58-.26.9-.26.22,0,.43.04.63.11.2.08.38.19.54.33l.25.25c.18.17.4.28.64.31.24.03.48-.03.68-.17.2-.14.34-.35.42-.58.08-.23.08-.48,0-.71-.08-.23-.23-.44-.44-.58l-1.32-1.13c-.15-.13-.3-.25-.46-.37-.16-.12-.32-.24-.48-.35-.16-.11-.32-.22-.48-.31-.16-.1-.32-.19-.48-.27-.16-.08-.32-.15-.48-.22-.16-.06-.32-.12-.48-.17-.16-.05-.32-.09-.48-.12s-.32-.06-.48-.07c-.16-.01-.32-.02-.48-.02s-.32,0-.48.02c-.16.01-.32.03-.48.04-.16.01-.32.03-.48.06-.16.03-.31.06-.47.09-.16.04-.31.08-.46.12-.15.05-.3.1-.45.16-.15.06-.29.12-.44.19-.14.07-.29.14-.43.21-.14.08-.28.16-.41.24-.13.09-.26.18-.39.28-.13.1-.25.2-.37.31-.12.11-.24.22-.35.33-.11.11-.22.23-.32.35-.1.12-.19.24-.28.37s-.17.26-.25.39c-.08.13-.15.27-.22.39-.07.13-.13.26-.18.39-.05.13-.1.26-.13.39-.04.13-.07.26-.09.39-.02.13-.03.26-.04.39-.01.13-.01.26-.01.39s0,.26.01.39c0,.13.01.26.03.39.02.13.04.26.07.39.03.13.07.26.11.39.04.13.09.25.14.38.05.12.11.25.17.37.06.12.13.24.2.36.07.12.15.23.23.35.08.11.17.22.26.33.09.11.19.21.29.31.1.1.2.19.31.28.11.09.22.18.34.25.12.08.24.15.37.21s.26.12.39.17c.13.05.27.09.4.13.13.04.27.07.4.09.13.02.27.04.4.05.13.01.27.02.4.02.13,0,.27,0,.4-.01s.27-.02.4-.04.27-.04.4-.07.27-.06.4-.09c.13-.03.27-.07.4-.11.13-.04.27-.09.4-.14.13-.05.27-.1.4-.16.13-.06.26-.12.39-.18.13-.07.26-.14.38-.21.12-.07.24-.15.35-.23.11-.08.22-.17.32-.26.1-.09.19-.18.28-.28.09-.1.17-.2.24-.3l.25-.25c.18-.17.4-.28.64-.31.24-.03.48.03.68-.17.2-.14.34-.35.42-.58.08.23.08.48,0,.71-.08.23-.23.44-.44.58l-.25.25c-.18.17-.4.28-.64.31-.24.03-.48-.03-.68-.17-.2-.14-.34-.35-.42-.58s-.08-.48,0-.71.08-.23.23-.44.44-.58,1.3-1.04,1.49-1.21,1.49-1.21.2-.14.4-.27c.2-.14.41-.27.61-.4.2-.13.41-.26.61-.38.2-.12.41-.24.61-.35.2-.11.4-.22.6-.32.2-.1.4-.2.59-.29.19-.09.38-.18.57-.25.18-.08.37-.15.55-.21.18-.06.36-.12.54-.16.18-.04.35-.08.53-.11.18-.03.35-.05.52-.06.17-.01.34-.02.51-.02z"/></svg>'},
  {id:'facebook_1', label:'Facebook', color:'#1877F2', pkg:'com.facebook.katana', url:'https://facebook.com', icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M22,12c0-5.52-4.48-10-10-10S2,6.48,2,12c0,4.84,3.44,8.87,8,9.8V15H8v-3h2V9.5C10,7.57,11.57,6,13.5,6H16v3h-2 c-0.55,0-1,0.45-1,1v2h3l-0.5,3h-2.5v6.8C18.56,20.87,22,16.84,22,12z"/></svg>'},
  {id:'twitter_1', label:'X (Twitter)', color:'#000000', pkg:'com.twitter.android', url:'https://twitter.com', icon:'<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H4.68l4.71 6.209L18.244 2.25zM17.105 19.95h1.61L7.71 4.02h-1.61l11.005 15.93z"></path></svg>'},
  {id:'camera_1', label:'Camera', color:'#7b61ff', pkg:'com.android.camera', url:'#', icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>'}
];

// DOM Elements
const get = (id) => document.getElementById(id);
const appsGrid = get('appsGrid');
const reasonBackdrop = get('reasonBackdrop');
const reasonEl = get('reason');
const continueBtn = get('continueBtn');
const cancelBtn = get('cancelBtn');
const quickChoices = get('quickChoices');
const statsWrap = get('statsWrap');
const settingsPanel = get('settingsPanel');
const statsPanel = get('statsPanel');
const btnStats = get('btnStats');
const btnSettings = get('btnSettings');
const btnReset = get('btnReset');
const addApp = get('addApp');
const toggleProtected = get('toggleProtected');
const modeText = get('modeText');
const saveSettings = get('saveSettings');
const cancelSettings = get('cancelSettings');
const closeSettings = get('closeSettings');
const cooldownInput = get('cooldown');
const whitelistInput = get('whitelist');
const btnExport = get('btnExport');
const btnImport = get('btnImport');
const fileImport = get('file-import');

// App Modal Elements
const appModalBackdrop = get('appModalBackdrop');
const appModalTitle = get('appModalTitle');
const appIdField = get('appIdField');
const appLabel = get('appLabel');
const appUrl = get('appUrl');
const appPkg = get('appPkg');
const appColor = get('appColor');
const appIcon = get('appIcon');
const saveAppModalBtn = get('saveAppModalBtn');
const cancelAppModalBtn = get('cancelAppModalBtn');

// State
let apps = [];
let logs = [];
let protectedMode = true;
let lastShown = {};
let cooldown = 4;
let whitelist = [];

function loadState() {
    apps = JSON.parse(localStorage.getItem('mindlock_apps') || 'null') || defaultApps;
    logs = JSON.parse(localStorage.getItem('mindlock_log') || '[]');
    protectedMode = JSON.parse(localStorage.getItem('mindlock_protected') || 'true');
    cooldown = parseInt(localStorage.getItem('mindlock_cooldown') || '4', 10);
    whitelist = (localStorage.getItem('mindlock_whitelist') || '').split(',').map(s => s.trim()).filter(Boolean);
    updateUI();
}

function saveState() {
    localStorage.setItem('mindlock_apps', JSON.stringify(apps));
    localStorage.setItem('mindlock_log', JSON.stringify(logs));
    localStorage.setItem('mindlock_protected', JSON.stringify(protectedMode));
    localStorage.setItem('mindlock_cooldown', cooldown);
    localStorage.setItem('mindlock_whitelist', whitelist.join(','));
}

function updateUI() {
    modeText.textContent = protectedMode ? 'ON' : 'OFF';
    cooldownInput.value = cooldown;
    whitelistInput.value = whitelist.join(',');
    renderApps();
    renderStats();
}

function renderApps() {
    appsGrid.innerHTML = '';
    apps.forEach(a => {
        const el = document.createElement('div');
        el.className = 'card';
        const iconHTML = a.icon ? a.icon : a.label.slice(0, 1);
        el.innerHTML = `
            <div class="icon" style="background:${a.color}">${iconHTML}</div>
            <div class="name">${a.label}</div>
            <div style="display:flex;gap:8px;margin-top:auto;padding-top:8px;">
                <button class="btn primary openBtn" data-id="${a.id}">Open</button>
                <button class="btn muted editBtn" data-id="${a.id}" title="Edit">Edit</button>
                <button class="btn danger deleteBtn" data-id="${a.id}" title="Delete">Del</button>
            </div>
        `;
        appsGrid.appendChild(el);
    });

    // Re-attach listeners
    document.querySelectorAll('.openBtn').forEach(b => b.onclick = e => handleOpen(e.currentTarget.dataset.id));
    document.querySelectorAll('.editBtn').forEach(b => b.onclick = e => openAppModal(e.currentTarget.dataset.id));
    document.querySelectorAll('.deleteBtn').forEach(b => b.onclick = e => deleteApp(e.currentTarget.dataset.id));
}

function handleOpen(id) {
    const app = apps.find(x => x.id === id);
    if (!app) return;
    const now = Date.now();
    
    if (whitelist.includes(app.pkg) || !protectedMode || (lastShown[app.id] && now - lastShown[app.id] < cooldown * 1000)) {
        simulateOpen(app);
        return;
    }
    openReasonModal(app);
}

function simulateOpen(app) {
    addLog(app, 'Opened (no reason)', Date.now(), true);
    showToast(`Opening ${app.label}...`);
    if (app.url && app.url !== '#') {
        window.open(app.url, '_blank');
    }
}

function openReasonModal(app) {
    reasonBackdrop.classList.add('show');
    reasonEl.value = '';
    reasonEl.dataset.appId = app.id;
    lastShown[app.id] = Date.now();
}

function closeReasonModal() {
    reasonBackdrop.classList.remove('show');
    reasonEl.dataset.appId = '';
}

continueBtn.onclick = () => {
    const appId = reasonEl.dataset.appId;
    const app = apps.find(x => x.id === appId);
    if (!app) return closeReasonModal();
    
    const reason = reasonEl.value.trim() || '—';
    addLog(app, reason, Date.now());
    closeReasonModal();
    showToast(`Thanks — Opening ${app.label}.`);

    // FIX: THIS LINE WAS MISSING. IT OPENS THE APP IN A NEW TAB.
    if (app.url && app.url !== '#') {
        window.open(app.url, '_blank');
    }
};

cancelBtn.onclick = () => {
    const appId = reasonEl.dataset.appId;
    const app = apps.find(x => x.id === appId);
    if (app) { addLog(app, 'Cancelled', Date.now()); }
    closeReasonModal();
    showToast('Action cancelled.');
};

quickChoices.querySelectorAll('.chip').forEach(ch => {
    ch.addEventListener('click', e => reasonEl.value = e.currentTarget.textContent);
});

function addLog(app, reason, ts = Date.now(), silent = false) {
    logs.push({ app: app.label, pkg: app.pkg, reason, ts });
    saveState();
    if (!silent) renderStats();
}

function renderStats() {
    statsWrap.innerHTML = '';
    const map = logs.reduce((acc, l) => {
        acc[l.app] = (acc[l.app] || 0) + 1;
        return acc;
    }, {});

    const entries = Object.entries(map).sort((a, b) => b[1] - a[1]);
    if (entries.length === 0) {
        statsWrap.innerHTML = '<div class="tiny" style="color:var(--muted)">No activity yet — open some apps.</div>';
        return;
    }

    const maxCount = Math.max(...entries.map(e => e[1]), 0);

    entries.forEach(([label, count]) => {
        const s = document.createElement('div');
        s.className = 'stat';
        const width = maxCount > 0 ? (count / maxCount) * 100 : 0;
        s.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <div style="font-weight:600">${label}</div>
                <div class="small">${count} opens</div>
            </div>
            <div class="stat-bar">
                <div class="stat-bar-inner" style="width:${width}%"></div>
            </div>
        `;
        statsWrap.appendChild(s);
    });
}

// Settings Panel Logic
btnStats.onclick = () => {
    statsPanel.style.display = statsPanel.style.display === 'none' ? 'block' : 'none';
    if(statsPanel.style.display === 'block') renderStats();
};
btnSettings.onclick = () => settingsPanel.style.display = 'block';
closeSettings.onclick = () => settingsPanel.style.display = 'none';
cancelSettings.onclick = () => settingsPanel.style.display = 'none';
saveSettings.onclick = () => {
    cooldown = parseInt(cooldownInput.value || '4', 10) || 0;
    whitelist = whitelistInput.value.split(',').map(s => s.trim()).filter(Boolean);
    saveState();
    updateUI();
    settingsPanel.style.display = 'none';
    showToast('Settings saved');
};

btnReset.onclick = () => {
    if (confirm('Reset all data (apps & logs)? This is irreversible.')) {
        localStorage.clear();
        lastShown = {};
        loadState(); // Reload defaults
        showToast('Reset complete');
    }
};

// Add/Edit App Modal Logic
function openAppModal(appId = null) {
    const isEditing = appId !== null;
    appModalTitle.textContent = isEditing ? 'Edit App' : 'Add New App';
    appIdField.value = isEditing ? appId : '';

    if (isEditing) {
        const app = apps.find(a => a.id === appId);
        if (!app) return;
        appLabel.value = app.label;
        appUrl.value = app.url;
        appPkg.value = app.pkg;
        appColor.value = app.color;
        appIcon.value = app.icon || '';
    } else {
        // Clear form for new app
        appLabel.value = '';
        appUrl.value = '';
        appPkg.value = '';
        appColor.value = '#7c3aed';
        appIcon.value = '';
    }
    appModalBackdrop.classList.add('show');
}

function closeAppModal() {
    appModalBackdrop.classList.remove('show');
}

addApp.onclick = () => openAppModal();
cancelAppModalBtn.onclick = closeAppModal;
saveAppModalBtn.onclick = () => {
    const id = appIdField.value;
    const newApp = {
        label: appLabel.value.trim(),
        url: appUrl.value.trim(),
        pkg: appPkg.value.trim().toLowerCase(),
        color: appColor.value,
        icon: appIcon.value.trim()
    };

    if (!newApp.label || !newApp.pkg) {
        showToast('App Label and Package Name are required.');
        return;
    }

    if (id) { // Editing
        const index = apps.findIndex(a => a.id === id);
        if (index > -1) {
            apps[index] = { ...apps[index], ...newApp };
        }
    } else { // Adding
        newApp.id = newApp.pkg + '_' + Date.now();
        apps.push(newApp);
    }
    saveState();
    renderApps();
    closeAppModal();
    showToast(`App ${id ? 'updated' : 'added'} successfully`);
};

function deleteApp(id) {
    const app = apps.find(a => a.id === id);
    if (!app) return;
    if (confirm(`Are you sure you want to delete ${app.label}?`)) {
        apps = apps.filter(a => a.id !== id);
        saveState();
        renderApps();
        showToast('App deleted');
    }
}

// Data Export/Import
btnExport.onclick = () => {
    const data = {
        apps,
        logs,
        settings: {
            protectedMode,
            cooldown,
            whitelist
        }
    };
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `mindlock-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Data exported');
};

btnImport.onclick = () => fileImport.click();
fileImport.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = JSON.parse(event.target.result);
            if (data.apps && data.logs && data.settings) {
                if (confirm('Importing will overwrite current data. Continue?')) {
                    apps = data.apps;
                    logs = data.logs;
                    protectedMode = data.settings.protectedMode;
                    cooldown = data.settings.cooldown;
                    whitelist = data.settings.whitelist;
                    saveState();
                    updateUI();
                    showToast('Data imported successfully!');
                }
            } else {
                throw new Error('Invalid backup file structure.');
            }
        } catch (error) {
            showToast('Error: Could not import file. ' + error.message);
        } finally {
            fileImport.value = ''; // Reset file input
        }
    };
    reader.readAsText(file);
};

toggleProtected.onclick = () => {
    protectedMode = !protectedMode;
    modeText.textContent = protectedMode ? 'ON' : 'OFF';
    saveState();
    showToast('Protected mode ' + (protectedMode ? 'enabled' : 'disabled'));
};

/* small toast */
let toastTimer = null;
function showToast(msg) {
    let t = document.getElementById('ml_toast');
    if (!t) {
        t = document.createElement('div');
        t.id = 'ml_toast';
        Object.assign(t.style, { position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)', background: '#001827', padding: '10px 16px', borderRadius: '10px', boxShadow: '0 8px 24px rgba(2,6,23,0.6)', zIndex: 60, color: '#bfe6ff', transition: 'opacity 0.3s', opacity: '0' });
        document.body.appendChild(t);
    }
    t.textContent = msg;
    setTimeout(() => { t.style.opacity = '1' }, 50); // fade in
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { t.style.opacity = '0'; }, 2500);
}

// Keyboard escape to close modals
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        if (reasonBackdrop.classList.contains('show')) closeReasonModal();
        if (appModalBackdrop.classList.contains('show')) closeAppModal();
    }
});

/* init */
loadState();
</script>
</body>
</html>